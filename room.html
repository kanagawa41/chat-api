<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ルーム</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript">
    
    
    $(document).ready(function(){
        var params = getParams();

        var room_hash = params['room_hash'];
        existRoom(room_hash);

        var user_hash = params['user_hash'];
        // ユーザが指定されている場合は、ユーザ情報を取得する。
        if(user_hash){
          existUser(room_hash, user_hash);
        }
    });
    
    /**
     * 部屋の存在チェック
     */
    function existRoom(room_hash) {
      $.ajax({
        type: 'GET',
        url: 'rooms/' + room_hash,
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }
        $('#room_name').text(response.name);
        $('#description').text(response.description);
        $('#room_hash').val(room_hash);
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + XMLHttpRequest.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }
    
    /**
     * ユーザの存在チェック
     */
    function existUser(room_hash, user_hash) {
      $.ajax({
        type: 'GET',
        url: 'rooms/' + room_hash + '/members/' + user_hash,
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたユーザは存在しません。'); return;
        }
        $('#user_name').val(response.name);
        $('#user_hash').val(user_hash);
        $('#login_url').val(location.href　+ '&user_hash=' + user_hash);
        $('#self_icon').val(response.icon);

        $('#user_name').prop('readonly',true);
        $('#message_body').prop('disabled', false);
        $('#message_submit').prop('disabled', false);

      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + XMLHttpRequest.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }
    
    /**
     * GETパラメータを配列にセットして返却する。
     */
    function getParams() {
        var url   = location.href;
        parameters    = url.split("?");
        params   = parameters[1].split("&");
        var paramsArray = [];
        for ( i = 0; i < params.length; i++ ) {
            neet = params[i].split("=");
            paramsArray.push(neet[0]);
            paramsArray[neet[0]] = neet[1];
        }
        return paramsArray;
    }

    /**
     * ルームに入室する
     */
    function intoRoom(){
      $.ajax({
        type: 'POST',
        url: 'rooms/' + $('#room_hash').val() + '/members',
        timeout: 10000,
        cache: false,
        data: {
            name : $('#user_name').val()
        },
        dataType: 'json',
        beforeSend: function(jqXHR) {
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }
        $('#user_hash').val(response.user_hash);
        $('#login_url').val(location.href　+ '&user_hash=' + response.user_hash);
        
        $('#user_name').attr('readonly',true);

        existUser($('#room_hash').val(), response.user_hash);

        // 周期的にメッセージを取得する処理の発動
        setInterval(function(){
           getMessages();
        },10000);
        
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * メッセージを取得する
     */
    function getMessages(){
      $.ajax({
        type: 'GET',
        url: 'rooms/' + $('#room_hash').val() + '/members/' + $('#user_hash').val() + '/messages',
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }

        response.forEach(function(value) {
            $('#message_stream').append(create_message(value));
        });

      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * FIXME メッセージが送信している間に抜けたりするなどの不具合がありそうなので、送信前に受信するようにする。
     * メッセージを送信する
     */
    function sendMessage(){
      var message_body = $('#message_body').val();
      if(! message_body) { return; }
      $('#message_body').val('');
      
      $.ajax({
        type: 'POST',
        url: 'rooms/' + $('#room_hash').val() + '/members/' + $('#user_hash').val() + '/messages',
        timeout: 10000,
        cache: false,
        data: {
            body : message_body
        },
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }
        
        var message_id = response.message_id;
        var user_name = $('#user_name').val();
        var who = 'self';

        var message_values = {
            message_id : response.message_id,
            body : message_body,
            user : {
                name : $('#user_name').val(),
                who : "self",
                icon : $('#self_icon').val(),
            },
            type : 1,
            sendTime : new Date(),
        };

        $('#message_stream').append(create_message(message_values));
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     *　メッセージ構成を作成し返却する。
     */
    function create_message(value){
        var message_id = value.message_id;
        var body = value.body;
        var user_name = value.user.name;
        var who = value.user.who;
        var icon = value.user.icon;
        var type = value.type;
        var sendTime = value.send_time;

        var result = '';
        if(who == 'self'){
            result = '<div class="question_Box"><div class="question_image"><img src="assets/image/user_icon/' + icon + '.gif' + '" alt="' + user_name + '"/></div><div class="arrow_question">' + body + '<input type="hidden" class="message_id" value="' + message_id + '">' + '</div>';
        } else if(who == 'other') {
            if(type == 2){ // メッセージの場合
                result = '<div class="question_Box"><div class="answer_image"><img src="assets/image/user_icon/' + icon + '.gif' + '" alt="' + user_name + '"/></div><div class="arrow_answer">' + body + '<input type="hidden" class="message_id" value="' + message_id + '">' + '</div>';
            } else if(type == 3){ // 入室の場合
                result = '<div class="question_Box">' + body + ' さんが入室しました。' + '</div>';
            } else if(type == 1){ // ルーム作成の場合
                result = '<div class="question_Box">' + body + ' が作成されました。' + '</div>';
            }
        }
        return result;
    }
    
</script>

<style type="text/css">
<!--
html {
    overflow-y: scroll;
    font-size: 62.5%;
}

body {
    width:100%;
    min-width: 320px;
    font-size: 10px;
    font-size: 1.0rem;
    font-family: "times new roman";
    -webkit-text-size-adjust: 100%;
     margin:0;
     padding: 0;
}

/* メッセージ表示範囲  */
#message_stream{
     margin: 5px auto;
     width:95%;
     height: 60vh;
     overflow: scroll;   /* スクロール表示 */ 
}

.arrow_answer,
.arrow_question {
    position: relative;
    background: #fff;
    border: 1px solid #c8c8c8;
    border-radius: 10px;
    width:75%;
    font-size: 11px;
    padding:3%;
}




.arrow_question {
    float: right;
}


.arrow_answer:after,
.arrow_answer:before,
.arrow_question:after,
.arrow_question:before {
    top: 30%;
    border: solid transparent;
    content: " ";
    height: 0;
    width: 0;
    position: absolute;
    pointer-events: none;
}




.arrow_question:after,
.arrow_question:before {
    right: 100%;
}


.arrow_answer:after,
.arrow_answer:before{
     left: 100%;
}


.arrow_answer:after,
.arrow_question:after {
    border-color: rgba(255, 255, 255, 0);
    border-width: 8px;
    margin-top: -8px;
}


.arrow_answer:after{
    border-left-color: #fff;
}


.arrow_question:after{
    border-right-color: #fff;
    
}


.arrow_answer:before,
.arrow_question:before {
    border-color: rgba(200, 200, 200, 0);
    border-width: 9px;
    margin-top: -9px;
}


.arrow_answer:before{
    border-left-color: #c8c8c8;
}


.arrow_question:before {
    border-right-color: #c8c8c8;    
}


.question_image{
     float: left;
     width:15%;
}


.answer_image{
     float: right;
     width:15%;
}


.answer_image img,
.question_image img{
     border-radius: 50px;
     width: 100%
}


.question_Box{
     width: 100%;
     overflow: hidden;
     margin-bottom: 8%;
}

/* フッターの背景 */
div#footer-bk
{
    background-color: #FFF;   /* 背景色(黒) */
    width:100%;               /* 横の幅を100% */
    height: 25px;            /* 縦の幅を120px */
    position: absolute;       /* 絶対位置指定することを定義 */
    bottom: 0px;              /* 絶対位置指定(左0px,下0px) */
}
/* フッターの表示領域 */
div#footer{
    height: 25px;          /* 縦幅の指定100px */
    width:100%;               /* 横の幅を100% */
    margin: auto;           /* 中央揃え */
}

-->
</style>

</head>
<body>
<h1 id="room_name">Dummy</h1>
<h2 id="description">Dummy</h2>
<input type="text" id="user_name" placeholder="ユーザ名"><button onclick="intoRoom()">入室</button>
<input type="hidden" id="user_hash">
<br>
<label>再入室用URL:</label><input type="text" id="login_url" placeholder="ログインURL"　readonly="readonly">
<br>
<!--
<ul id="message_stream">
</ul>
-->
<div id="message_stream">
</div>
<div id="footer-bk">
    <div id="footer"><input type="text" id="message_body" placeholder="メッセージ" disabled="disabled" style="width:89%;height:25px;"><button id="message_submit" onclick="sendMessage()" disabled="disabled" style="width:10%;height:31px;">▶</button></div>
</div>
<input type="hidden" id="room_hash">
<input type="hidden" id="self_icon">
</body>
</html>
