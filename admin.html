<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ルーム</title>
<link rel="stylesheet" type="text/css" href="assets/css/common/reset.css">
<link rel="stylesheet" type="text/css" href="assets/css/common/setting.css">
<link rel="stylesheet" type="text/css" href="assets/css/room/room.css">
<link rel="stylesheet" type="text/css" href="assets/css/slicknav/slicknav.css">
<link rel="stylesheet" type="text/css" href="assets/css/bootstrap-v3-3-7/bootstrap.min.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/common/http-input.js"></script>
<script type="text/javascript" src="assets/js/slicknav/jquery.slicknav.min.js"></script>
<script type="text/javascript" src="assets/js/bootstrap-v3-3-7/bootstrap.min.js"></script>
<script type="text/javascript">
    var GET_MESSAGE_INTERVAL = 10000;

    $(document).ready(function(){
        /* FIXME 画面を開いたときから制御不能状態のマスクをかけたい */

        var params = HttpInput.getParams();

        var room_hash = params['room'];
        existRoom(room_hash);
    });
    
    /**
     * FIXME もっとかっこいいダイアログに変更する。
     * 入室ダイアログを表示する。
     */
    function inRoomInputDisplay(){
      // 入力ダイアログを表示 ＋ 入力内容を user に代入
      user_name = window.prompt("ユーザー名を入力してください", "");

      if(user_name == '' || user_name == null){
        alert('名前が入力されていません。');
      }　else　{
        $('#user_name').val(user_name);
        intoRoom();
      }

    }

    /**
     * 部屋の存在チェック
     */
    function existRoom(room_hash) {
      $.ajax({
        type: 'GET',
        url: 'rooms/' + room_hash,
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }
        $('#description').text(response.description);
        $('#room_hash').val(room_hash);

      　　// スリックバー作動
        $('#menu_navi').slicknav();
        var menuHeight = parseInt($('.slicknav_menu').outerHeight());
        $('#message_stream').css('margin-top', menuHeight);
        $('#message_stream').css('height', 
          parseInt(screen.height) - (menuHeight + parseInt($('#message_input_area').height()))
        );
        $('.slicknav_btn').after('<div style="font-size: 1.5em; text-align: center;">' + response.name + '</div>');

        // ユーザが指定されている場合は、ユーザ情報を取得する。
        existUser(room_hash);
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + XMLHttpRequest.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }
    
    /**
     * ユーザの存在チェック
     */
    function existUser(room_hash) {
      $.ajax({
        type: 'GET',
        url: 'rooms/' + room_hash + '/members',
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            inRoomInputDisplay();
            return;
        }
        $('#user_name').val(response.name);
        $('#self_icon').val(response.icon);

        $('#message_body').prop('disabled', false);
        $('#message_submit').prop('disabled', false);

        getPastMessages();
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + XMLHttpRequest.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * 過去のメッセージを取得する
     */
    function getPastMessages(){
      $.ajax({
        type: 'GET',
        url: 'rooms/' + $('#room_hash').val() + '/messages/all',
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }

        var compareDate1 = '';
        response.forEach(function(value) {
            var compareDate2 = calcDate(value.send_time);
            if(compareDate1 != compareDate2){
              $('#message_stream').append('<div class="information_box">' + compareDate2 + '</div>');
              compareDate1 = compareDate2;
              $('#last_send_date').val(compareDate1);
            }
            $('#message_stream').append(create_message(value));
        });

        // 周期的にメッセージを取得する処理の発動
        setInterval(function(){
           getMessages();
        }, GET_MESSAGE_INTERVAL);
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * ルームに入室する
     */
    function intoRoom(){
      $.ajax({
        type: 'POST',
        url: 'rooms/' + $('#room_hash').val() + '/members',
        timeout: 10000,
        cache: false,
        data: {
            name : $('#user_name').val()
        },
        dataType: 'json',
        beforeSend: function(jqXHR) {
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }
        window.location.href = window.location.href.split('?')[0] + "?room=" + response.room_hash;

      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * メッセージを取得する
     */
    function getMessages(){
      $.ajax({
        type: 'GET',
        url: 'rooms/' + $('#room_hash').val() + '/messages',
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }

        var compareDate1 = $('#last_send_date').val();
        response.forEach(function(value) {
            var compareDate2 = calcDate(value.send_time);
            if(compareDate1 != compareDate2){
              $('#message_stream').append('<div class="information_box">' + compareDate2 + '</div>');
              compareDate1 = compareDate2;
              $('#last_send_date').val(compareDate1);
            }
            $('#message_stream').append(create_message(value));
        });

      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    function calcDate(date_str){
      //文字列からミリ秒を取得
      var time = Date.parse(date_str);

      //ミリ秒から日付を求める
      var date = new Date();
      date.setTime(time);

      var y = date.getFullYear();
      var m = date.getMonth() + 1;
      var d = date.getDate();
      var w = date.getDay();

      var wNames = ['日', '月', '火', '水', '木', '金', '土'];

      // 「月」と「日」で1桁だったときに頭に 0 をつける
      if (m < 10) {
        m = '0' + m;
      }
      if (d < 10) {
        d = '0' + d;
      }

      return y + '/' + m + '/' + d + ' (' + wNames[date.getDay()] + ')';
    }

    function calcTime(date_str){
      //文字列からミリ秒を取得
      var time = Date.parse(date_str);

      //ミリ秒から日付を求める
      var date = new Date();
      date.setTime(time);

      var h = date.getHours();
      var m = date.getMinutes();

      // 「月」と「日」で1桁だったときに頭に 0 をつける
      if (h < 10) {
        h = '0' + h;
      }
      if (m < 10) {
        m = '0' + m;
      }

      return h + ':' + m;
    }

    /**
     * FIXME メッセージが送信している間に抜けたりするなどの不具合がありそうなので、送信前に受信するようにする。
     * メッセージを送信する
     */
    function sendMessage(){
      var message_body = $('#message_body').val();
      if(! message_body) { return; }
      $('#message_body').val('');
      
      $.ajax({
        type: 'POST',
        url: 'rooms/' + $('#room_hash').val() + '/messages',
        timeout: 10000,
        cache: false,
        data: {
            body : message_body
        },
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }

        getMessage(response.message_id);
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * メッセージを取得する
     */
    function getMessage(message_id){
      $.ajax({
        type: 'GET',
        url: 'rooms/' + $('#room_hash').val() + '/messages/' + message_id,
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }

        var compareDate1 = $('#last_send_date').val();
        var compareDate2 = calcDate(response.send_time);

        if(compareDate1 != compareDate2){
          $('#message_stream').append('<div class="information_box">' + compareDate2 + '</div>');
          $('#last_send_date').val(compareDate2);
        }

        $('#message_stream').append(create_message(response));
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     *　メッセージ構成を作成し返却する。
     */
    function create_message(value){
        var message_id = value.message_id;
        var body = value.body;
        var user_name = value.user.name;
        var who = value.user.who;
        var icon = value.user.icon;
        var hash = value.user.hash;
        var type = value.type;
        var sendTime = calcTime(value.send_time);
        var sendDate = calcDate(value.send_time);

        var result = '';
        if(who == 'self'){
            result = '<div class="question_box"><div class="answer_image"><img src="assets/image/user_icon/' + icon + '.gif' + '" alt="' + user_name + '"/>' + '<div class="send_time">' + sendTime + '</div>' + '</div><p class="answer_name">' + user_name + '　' + hash + '</p><div class="arrow_answer">' + body + '<input type="hidden" class="message_id" value="' + message_id + '">' + '</div>';
        } else if(who == 'other') {
            if(type == 2){ // メッセージの場合
                result = '<div class="question_box"><div class="question_image"><img src="assets/image/user_icon/' + icon + '.gif' + '" alt="' + user_name + '"/>' + '<div class="send_time">' + sendTime + '</div>' + '</div><p class="question_name">' + user_name + '　' + hash + '</p><div class="arrow_question">' + body + '<input type="hidden" class="message_id" value="' + message_id + '">' + '</div>';
            } else if(type == 3){ // 入室の場合
                result = '<div class="information_box">' + body + ' さんが入室しました。' + '</div>';
            } else if(type == 1){ // ルーム作成の場合
                result = '<div class="information_box">' + body + ' が作成されました。' + '</div>';
            }
        }
        return result;
    }
    
</script>
</head>
<body>
<ul id="menu_navi" class="clearfix">
      <li><h2 id="description"></h2></li>
</ul>
<input type="hidden" id="user_name">
<div id="message_stream">
</div>
<div id="message_input_area" class="input-group">
    <input type="text" id="message_body" class="form-control input-xs" placeholder="メッセージ">
    <span class="input-group-btn">
      <button type="button" class="btn btn-primary" id="message_submit" onclick="sendMessage();">送信</button>
    </span>
</div>
<input type="hidden" id="room_hash">
<input type="hidden" id="self_icon">
<input type="hidden" id="last_send_date" value="">
</body>
</html>
