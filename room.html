<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ルーム</title>
<link rel="stylesheet" type="text/css" href="assets/css/common/reset.css">
<link rel="stylesheet" type="text/css" href="assets/css/common/setting.css">
<link rel="stylesheet" type="text/css" href="assets/css/room/room.css">
<link rel="stylesheet" type="text/css" href="assets/css/slicknav/slicknav.css">
<link rel="stylesheet" type="text/css" href="assets/css/bootstrap-v3-3-7/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="assets/css/toastr/toastr.min.css"/>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/common/http-input.js"></script>
<script type="text/javascript" src="assets/js/slicknav/jquery.slicknav.min.js"></script>
<script type="text/javascript" src="assets/js/bootstrap-v3-3-7/bootstrap.min.js"></script>
<script type="text/javascript" src="assets/js/toastr/toastr.min.js"></script>
<script type="text/javascript" src="assets/js/inview/jquery.inview.min.js"></script>
<script type="text/javascript" src="assets/js/fingerprint/fingerprint.js"></script>

<script type="text/javascript">
    // メッセージ取得インターバル
    var GET_MESSAGE_INTERVAL = 5500;
    // トースター情報
    var TOASTR = null;
    // メッセージ最後の座標
    var MESSAGE_Y_POSITION = null;
    // フィンガープリント
    var FINGERPRINT = null;

    $(document).ready(function(){
        /* FIXME 画面を開いたときから制御不能状態のマスクをかけたい */

        var fp = new Fingerprint();
        FINGERPRINT = fp.get();

        // トースター
        toastr.options.timeOut = 3000;
        toastr.options = {
          "closeButton": true,
          "debug": false,
          "newestOnTop": true,
          "progressBar": false,
          "positionClass": "toast-top-full-width",
          "preventDuplicates": false,
          "showDuration": "300",
          "hideDuration": "1000",
          "timeOut": "5000",
          "extendedTimeOut": "1000",
          "showEasing": "swing",
          "hideEasing": "linear",
          "showMethod": "fadeIn",
          "hideMethod": "fadeOut",
          "tapToDismiss": false
        }
        TOASTR = toastr;

        var params = HttpInput.getParams();

        var room_hash = params['room'];
        existRoom(room_hash);
    });
    
    function validUserInfo(){
        var userName = $('#name').val();
        if(userName == ''){
          TOASTR["warning"]("使用するユーザ名が入力されていません。", "入力エラー"); return;
        } 

        var sex = $('[class="sex"]:checked').map(function(){
          return $(this).val();
        }).get();

        if(sex == null){
          TOASTR["warning"]("性別が選択されていません。", "入力エラー"); return;
        }

        $('#user_name').val(userName);
        $('#user_sex').val(sex[0]);
        intoRoom();
    }

    /**
     * 部屋の存在チェック
     */
    function existRoom(room_hash) {
      $.ajax({
        type: 'GET',
        url: 'rooms/' + room_hash,
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー"); return;
        }
        $('#description').text(response.description);
        $('#room_hash').val(room_hash);

      　　// スリックバー作動
        $('#menu_navi').slicknav();
        var menuHeight = parseInt($('.slicknav_menu').outerHeight());
        // スリックバーの詳細と被らないようにメッセージの表示位置を指定している。
        $('#message_stream').css('margin-top', menuHeight);
        $('#message_stream').css('height', 
          parseInt(screen.height) - (menuHeight + parseInt($('#message_input_area').height()))
        );
        $('.slicknav_menu').after('<div id="now_date" style="top:' + (menuHeight + 10) + 'px;"></div>');

        var titleName = null;
        if(response.name.length > 8){
          titleName = response.name.substring(0, 8) + '...';
        } else {
          titleName　= response.name;
        }
        $('.slicknav_btn').after('<div style="font-size: 0.9em; text-align: center; line-height: ' + parseInt($('.slicknav_menu').height()) + 'px;">' + titleName　+ '</div>');

        // ユーザが指定されている場合は、ユーザ情報を取得する。
        existUser(room_hash);
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + XMLHttpRequest.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }
    
    /**
     * ユーザの存在チェック
     */
    function existUser(room_hash) {
      $.ajax({
        type: 'GET',
        url: 'rooms/' + room_hash + '/members',
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            //ユーザ情報入力モーダルを表示
            $('#input-modal').modal('show'); return;
        }
        $('#user_name').val(response.name);
        $('#user_sex').val(response.sex);
        $('#self_icon').val(response.icon);

        $('#message_body').prop('disabled', false);
        $('#message_submit').prop('disabled', false);

        $('#message_submit').height($('#message_body').height());

        //画面を一番下までスクロールする。
        //アンドロイドのブラウザがＵＲＬ分の縦幅を途中でなくため誤作動が起きる。
        setTimeout(function() {
            window.scroll(0,$(document).height());
        },0);

        getPastMessages();
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        TOASTR["error"]("接続が正しく行われませんでした。", "システムエラー");

        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * 過去のメッセージを取得する
     */
    function getPastMessages(){
      $.ajax({
        type: 'GET',
        url: 'rooms/' + $('#room_hash').val() + '/messages/all',
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー"); return;
        }

        var compareDate1 = null;
        response.forEach(function(value) {
            var compareDate2 = calcDate(value.send_time);
            if(compareDate1 != compareDate2){
              createDateMessage(value.send_time, compareDate2);
              compareDate1 = compareDate2;
            }
            $('#message_stream').append(create_message(value));
        });

        $('#now_date').text(compareDate1);

        messageScrollButtom();

        // 周期的にメッセージを取得する処理の発動
        setInterval(function(){
           getMessages();
        }, GET_MESSAGE_INTERVAL);
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        TOASTR["error"]("接続が正しく行われませんでした。", "システムエラー");

        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * ルームに入室する
     */
    function intoRoom(){
      $.ajax({
        type: 'POST',
        url: 'rooms/' + $('#room_hash').val() + '/members',
        timeout: 10000,
        cache: false,
        data: {
            name : $('#user_name').val(),
            sex : $('#user_sex').val(),
            fingerprint : FINGERPRINT
        },
        dataType: 'json',
        beforeSend: function(jqXHR) {
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            if(response["errors"][0] == 'User already exist.'){
              TOASTR["warning"]("既にユーザは作成されています。", "重複登録エラー"); return;
            } else {
              TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー"); return;
            }
        }
        window.location.href = window.location.href.split('?')[0] + "?room=" + response.room_hash;

      }).fail(function(jqXHR, textStatus, errorThrown ) {
        TOASTR["error"]("接続が正しく行われませんでした。", "システムエラー");

        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * メッセージを取得する
     */
    function getMessages(){
      $.ajax({
        type: 'GET',
        url: 'rooms/' + $('#room_hash').val() + '/messages',
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー"); return;
        }

        var addCommendFlag = null;
        var compareDate1 = $('#last_send_date').val();
        response.forEach(function(value) {
            addCommendFlag = value.body;
            var compareDate2 = calcDate(value.send_time);
            if(compareDate1 != compareDate2){
              createDateMessage(value.send_time, compareDate2);
              compareDate1 = compareDate2;
            }
            $('#message_stream').append(create_message(value));
        });

        if(addCommendFlag){
          // メッセージの表示位置が最後と離れている場合
          if($('#message_stream div:last-child').offset().top != MESSAGE_Y_POSITION){
            TOASTR["info"]('<a href="javascript:void(0);" class="clear" onclick="messageScrollButtom();">' + addCommendFlag + '</a>', '▼');
          } else {
            $('#message_stream').append(create_message(response));
            messageScrollButtom();
          }
        }
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        TOASTR["error"]("接続が正しく行われませんでした。", "システムエラー");

        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    function calcDate(date_str){
      //文字列からミリ秒を取得
      var time = Date.parse(date_str.replace(/-/g,"/"));

      //ミリ秒から日付を求める
      var date = new Date();
      date.setTime(time);

      var y = date.getFullYear();
      var m = date.getMonth() + 1;
      var d = date.getDate();
      var w = date.getDay();

      var wNames = ['日', '月', '火', '水', '木', '金', '土'];

      // 「月」と「日」で1桁だったときに頭に 0 をつける
      if (m < 10) {
        m = '0' + m;
      }
      if (d < 10) {
        d = '0' + d;
      }

      return y + '/' + m + '/' + d + ' (' + wNames[date.getDay()] + ')';
    }

    function calcTime(date_str){
      //文字列からミリ秒を取得
      var time = Date.parse(date_str.replace(/-/g,"/"));

      //ミリ秒から日付を求める
      var date = new Date();
      date.setTime(time);

      var h = date.getHours();
      var m = date.getMinutes();

      // 「月」と「日」で1桁だったときに頭に 0 をつける
      if (h < 10) {
        h = '0' + h;
      }
      if (m < 10) {
        m = '0' + m;
      }

      return h + ':' + m;
    }

    /**
     * FIXME メッセージが送信している間に抜けたりするなどの不具合がありそうなので、送信前に受信するようにする。
     * メッセージを送信する
     */
    function sendMessage(){
      var message_body = $('#message_body').val();
      if(! message_body) { return; }
      $('#message_body').val('');
      
      $.ajax({
        type: 'POST',
        url: 'rooms/' + $('#room_hash').val() + '/messages',
        timeout: 10000,
        cache: false,
        data: {
            body : message_body
        },
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー"); return;
        }

        getMessage(response.message_id);
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        TOASTR["error"]("接続が正しく行われませんでした。", "システムエラー");

        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * メッセージを取得する
     */
    function getMessage(message_id){
      $.ajax({
        type: 'GET',
        url: 'rooms/' + $('#room_hash').val() + '/messages/' + message_id,
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー"); return;
        }

        var compareDate1 = $('#last_send_date').val();
        var compareDate2 = calcDate(response.send_time);

        if(compareDate1 != compareDate2){
          createDateMessage(response.send_time, compareDate2);
        }

        var message = create_message(response);
        if(message != null){
            $('#message_stream').append(create_message(response));
            messageScrollButtom();
        }
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        TOASTR["error"]("接続が正しく行われませんでした。", "システムエラー");

        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     *　メッセージ構成を作成し返却する。
     */
    function create_message(value){
        var message_id = value.message_id;
        var body = value.body.replace(/\n/g, '<br>'); // 改行コード置換
        var user_name = value.user.name;
        var who = value.user.who;
        var icon = value.user.icon;
        var hash = value.user.hash;
        var type = value.type;
        var sendTime = calcTime(value.send_time);
        var sendDate = calcDate(value.send_time);

        var result = '';

        if(type == 3){ // 入室の場合
            result = '<div class="information_box">' + body + ' さんが入室しました。' + '</div>';
        } else if(type == 1){ // ルーム作成の場合
            //bodyに部屋名が入力されているが、部屋名を表示すると途中で部屋名を変更したときの齟齬の調整が面倒なので表示しない。
            result = '<div class="information_box">ルームが作成されました。' + '</div>'; 
        }　else if(type == 2){ // メッセージの場合
            if(who == 'self'){
                result = '<div class="question_box"><div class="answer_image"><img src="assets/image/user_icon/' + icon + '.gif' + '" alt="' + user_name + '"/>' + '<div class="send_time">' + sendTime + '</div>' + '</div><p class="answer_name">' + user_name + '　' + hash + '</p><div class="arrow_answer">' + body + '<input type="hidden" class="message_id" value="' + message_id + '">' + '</div>';
            } else if(who == 'other') {
                result = '<div class="question_box"><div class="question_image"><img src="assets/image/user_icon/' + icon + '.gif' + '" alt="' + user_name + '"/>' + '<div class="send_time">' + sendTime + '</div>' + '</div><p class="question_name">' + user_name + '　' + hash + '</p><div class="arrow_question">' + body + '<input type="hidden" class="message_id" value="' + message_id + '">' + '</div>';
            }
        } else {
            return null;
        }

        return result;
    }

    /**
     * 日付メッセージの表示共通処理
     */
    function createDateMessage(rawDateValue, dateValue){
        var id = rawDateValue.split(' ')[0];
        $('#message_stream').append('<div class="information_box" id="' + id + '">' + dateValue + '</div>');
        $('#' + id).on('inview', function(event, isInView, visiblePartX, visiblePartY) {
            if (isInView) { //要素が見えたときに実行する処理
                $('#now_date').text(dateValue);
            }
        });
        $('#last_send_date').val(dateValue);
    }
    
    /**
     * メッセージ欄を一番下までスクロールする
     */
    function messageScrollButtom(){
        // 一番下までスクロールする
        $('#message_stream').animate({scrollTop: $('#message_stream')[0].scrollHeight}, 'fast');
        MESSAGE_Y_POSITION = $('#message_stream div:last-child').offset().top;
    }

</script>
</head>
<body>
<ul id="menu_navi" class="clearfix">
      <li><h2 id="description"></h2></li>
</ul>
<input type="hidden" id="user_name">
<input type="hidden" id="user_sex">
<div id="message_stream">
</div>
<div id="message_input_area" class="input-group">
    <!-- font-size:16pxはiphoneの入力時の拡大を避けるため -->
    <textarea id="message_body" class="form-control input-xs" style="font-size:16px" placeholder="メッセージ"></textarea>
    <span class="input-group-btn">
      <button type="button" class="btn btn-primary" id="message_submit" onclick="sendMessage();">送信</button>
    </span>
</div>
<input type="hidden" id="room_hash">
<input type="hidden" id="self_icon">
<input type="hidden" id="last_send_date" value="">
<div class="modal fade" id="input-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">ユーザを作成</h4>
      </div>
      <div class="modal-body">
          <input type="text" id="name" placeholder="名前" class="form-control">
          <label class="radio-inline"><input type="radio" name="sex" class="sex" value="1" checked="checked">男</label>
          <label class="radio-inline"><input type="radio" name="sex" class="sex" value="2">女</label>
      </div>
      <div class="modal-footer">
        <!-- <button type="button" class="btn btn-default" data-dismiss="modal">閉じる</button> -->
        <button type="button" class="btn btn-primary" onclick="validUserInfo()">作成</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
