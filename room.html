<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ルーム</title>
<link rel="stylesheet" type="text/css" href="assets/css/common/reset.css">
<link rel="stylesheet" type="text/css" href="assets/css/common/setting.css">
<link rel="stylesheet" type="text/css" href="assets/css/room/room.css">
<link rel="stylesheet" type="text/css" href="assets/css/slicknav/slicknav.css">
<link rel="stylesheet" type="text/css" href="assets/css/bootstrap-v3-3-7/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="assets/css/toastr/toastr.min.css"/>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/common/http-input.js"></script>
<script type="text/javascript" src="assets/js/slicknav/jquery.slicknav.min.js"></script>
<script type="text/javascript" src="assets/js/bootstrap-v3-3-7/bootstrap.min.js"></script>
<script type="text/javascript" src="assets/js/toastr/toastr.min.js"></script>
<script type="text/javascript" src="assets/js/inview/jquery.inview.min.js"></script>
<script type="text/javascript" src="assets/js/fingerprint/fingerprint.js"></script>

<script type="text/javascript">
    // メッセージ取得インターバル
    var GET_MESSAGE_INTERVAL = 1000 * 10;
    // トースター情報
    var TOASTR = null;
    // メッセージ最後の座標
    var MESSAGE_Y_POSITION = null;
    // フィンガープリント
    var FINGERPRINT = null;
    // ラストメッセージID
    var LAST_MESSAGE_ID = null;
    // AJAXのリクエストパラメータのひな形
    var AJAX_REQUEST_MODEL = {
        type: 'GET',
        url: '',
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        }
    };
    // AJAXの接続失敗の処理
    var AJAX_FAIL = function(XMLHttpRequest, textStatus, errorThrown ) {
        TOASTR["error"]("接続が正しく行われませんでした。", "システムエラー");

        console.log("XMLHttpRequest : " + XMLHttpRequest.responseText);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown);
    };


    $(document).ready(function(){
        /* FIXME 画面を開いたときから制御不能状態のマスクをかけたい */

        var fp = new Fingerprint();
        FINGERPRINT = fp.get();

        // トースター
        toastr.options.timeOut = 3000;
        toastr.options = {
          "closeButton": true,
          "debug": false,
          "newestOnTop": true,
          "progressBar": false,
          "positionClass": "toast-top-full-width",
          "preventDuplicates": false,
          "showDuration": "300",
          "hideDuration": "1000",
          "timeOut": "5000",
          "extendedTimeOut": "1000",
          "showEasing": "swing",
          "hideEasing": "linear",
          "showMethod": "fadeIn",
          "hideMethod": "fadeOut",
          "tapToDismiss": false
        }
        TOASTR = toastr;

        var params = HttpInput.getParams();

        var room_hash = params['room'];
        existRoom(room_hash);
    });
    
    function validUserInfo(){
        var userName = $('#name').val();
        if(userName == ''){
          TOASTR["warning"]("使用するユーザ名が入力されていません。", "入力エラー"); return;
        } 

        var sex = $('[class="sex"]:checked').map(function(){
          return $(this).val()[0];
        }).get();

        if(sex == null){
          TOASTR["warning"]("性別が選択されていません。", "入力エラー"); return;
        }

        $('#user_name').val(userName);
        $('#user_sex').val(sex);
        $('#user_icon').val($('#icon').val());
        intoRoom();
    }

    /**
     * 部屋の存在チェック
     */
    function existRoom(room_hash) {
      var ajaxRequest = AJAX_REQUEST_MODEL;
      ajaxRequest['url'] = 'rooms/' + room_hash;
      ajaxRequest['data'] = {};
    
      $.ajax(ajaxRequest
      ).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー"); return;
        }
        $('#description').text(response.description);
        $('#room_hash').val(room_hash);
        LAST_MESSAGE_ID = response.last_message_id;

        // スリックバー作動
        $('#menu_navi').slicknav();
        var menuHeight = parseInt($('.slicknav_menu').outerHeight());
        // スリックバーの詳細と被らないようにメッセージの表示位置を指定している。
        $('#message_stream_top_margin').css('height', menuHeight);
        $('#message_stream').css('height', 
          parseInt(screen.height) - (menuHeight + parseInt($('#message_input_area').height()))
        );
        $('#message_stream').append('<div style="display: none;"></div>'); // ダミー要素を入れておく。エラー対策。
        // TODO　この機能はメッセージをスクロールした際に日付の変わり目で値を変えられるようにできたら実装する。
        //$('.slicknav_menu').after('<div id="now_date" style="top:' + (menuHeight + 10) + 'px;"></div>');

        $('.slicknav_btn').after('<div style="font-size: 0.9em; text-align: center; line-height: ' + parseInt($('.slicknav_menu').height()) + 'px;">' + chop(response.name, 8, '...') + '</div>');

        // ユーザが指定されている場合は、ユーザ情報を取得する。
        existUser(room_hash);
      }).fail(AJAX_FAIL);
    }
    
    /**
     * 指定数で文字を切り抜き、指定の文字を付与する
     */
    function chop(targetString, strLength, char){
        return targetString.length > strLength ? targetString.substring(0, strLength) + char : targetString;
    }

    /**
     * ユーザの存在チェック
     */
    function existUser(room_hash) {
      var ajaxRequest = AJAX_REQUEST_MODEL;
      ajaxRequest['url'] = 'rooms/' + room_hash + '/members';
      ajaxRequest['data'] = {};
    
      $.ajax(ajaxRequest
      ).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            //ユーザ情報入力モーダルを表示
            $('#input-modal').modal('show'); 
            $('#icon').val(Math.floor( Math.random() * 12) + 1); // ランダムに初期設定を変える
            return;
        }
        $('#user_name').val(response.name);
        $('#user_sex').val(response.sex);
        $('#self_icon').val(response.icon);

        $('#message_body').prop('disabled', false);
        $('#message_submit').prop('disabled', false);

        $('#message_submit').height($('#message_body').height());

        //画面を一番下までスクロールする。
        //アンドロイドのブラウザがＵＲＬ分の縦幅を途中でなくため誤作動が起きる。
        setTimeout(function() {
            window.scroll(0,$(document).height());
        },0);

        getPastMessages(LAST_MESSAGE_ID + 1); // 1を足しているのは、最後のメッセージを取得するようにするため

        messageScrollButtom();

        fetchMessagesSse();

      }).fail(AJAX_FAIL);
    }

    /**
     * 過去のメッセージを取得する
     */
    function getPastMessages(lastMessageID){
      var ajaxRequest = AJAX_REQUEST_MODEL;
      ajaxRequest['url'] = 'rooms/' + $('#room_hash').val() + '/messages/past/' + lastMessageID;
      ajaxRequest['data'] = {};

      $.ajax(ajaxRequest
      ).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー"); return;
        }

        if(response.length == 0){
          return;
        }

        var firstMessageId = null;
        var tempMessages = [];
        response.forEach(function(value) {
            if(firstMessageId == null){
                firstMessageId = value.message_id;
            }
            tempMessages.push(create_message(value));
        });

        $('#message_stream').prepend('<div id="move_mark"></div>'); //prependで自動的に上へ移動するので元の位置に戻す用のマーク

        tempMessages.reverse();
        tempMessages.forEach(function(value) {
            $('#message_stream').prepend(value);
        });

        $('#message_stream').prepend('<div id="' + firstMessageId + '"></div>');

        // FIXME 一旦上へスクロールしてからもとに戻るので美しくない。
        // prependした際に自動的に上へスクロールするので移動させている
        $('#message_stream').animate({scrollTop: $('#move_mark').offset().top}, 'fast');
        $('#move_mark').remove();

        $('#' + firstMessageId).on('inview', function(event, isInView, visiblePartX, visiblePartY) {
            if (isInView) { //要素が見えたときに実行する処理
                $('#' + firstMessageId).remove();
                getPastMessages(firstMessageId);
            }
        });

      }).fail(AJAX_FAIL);
    }

    /**
     * ルームに入室する
     */
    function intoRoom(){
      var ajaxRequest = AJAX_REQUEST_MODEL;
      ajaxRequest['url'] = 'rooms/' + $('#room_hash').val() + '/members';
      ajaxRequest['data'] = {
            name : $('#user_name').val(),
            sex : $('#user_sex').val(),
            icon : $('#user_icon').val(),
            fingerprint : FINGERPRINT
      };

      $.ajax(ajaxRequest
      ).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            if(response["errors"][0] == 'User already exist.'){
              TOASTR["warning"]("既にユーザは作成されています。", "重複登録エラー"); return;
            } else {
              TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー"); return;
            }
        }
        window.location.href = window.location.href.split('?')[0] + "?room=" + response.room_hash;

      }).fail(AJAX_FAIL);
    }

    /**
     * メッセージを取得する
     */
    function fetchMessagesSse(){
      var es = new EventSource('rooms/' + $('#room_hash').val() + '/messages/sse');

      // メッセージを取得
      es.addEventListener('messages', function (event) {
          var addCommendFlag = null;
          console.log(JSON.stringify(JSON.parse(event.data)));
          JSON.parse(event.data).forEach(function(value) {
              addCommendFlag = value.body;
              $('#message_stream').append(create_message(value));
          });

          if(addCommendFlag){
            // メッセージの表示位置が最後と離れている場合
            if($('#message_stream div:last-child').offset().top != MESSAGE_Y_POSITION){
              TOASTR["info"]('<a href="javascript:void(0);" class="clear" onclick="messageScrollButtom();">' + addCommendFlag + '</a>', '新着メッセージ');
            } else {
              messageScrollButtom();
            }
          }

      });

      // バリデーションエラー
      es.addEventListener('errors', function (event) {
          console.log(event.data);
          TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー");
          es.close();
      });

      es.onopen = function() {
          console.log('EventSource open');
      };

      es.onclose = function(code, reason) {
          console.log(code, reason);
          TOASTR["error"]("接続が切断されました。", "システムエラー");
      }

      // ＰＨＰ側のタイムアウトで発生することもある。
      es.onerror = function(e) {
          if (e.readyState === EventSource.CONNECTING) { // === 0 
            console.log("EventSource error: 再接続中");
          } else if (e.readyState === EventSource.OPEN) { // === 1
            console.log("EventSource error: 接続中");
          } else if (e.readyState === EventSource.CLOSED) { // === 2
            console.log("EventSource error: 終了");
          }
      };
    }

    /**
     * 日付を指定のフォーマットに変換する。
     * 2016/01/01 (月)
     * ※曜日はフラグで出力変更可能
     */
    function formatDate(dateStr, daysFLag){
      // 置換をしているのはChromeとsafari対策
      var time = Date.parse(dateStr.replace(/-/g,"/"));

      //ミリ秒から日付を求める
      var date = new Date();
      date.setTime(time);
      date.setHours(date.getHours() + 9); //UTC基準のため

      var y = date.getFullYear();
      var m = date.getMonth() + 1;
      var d = date.getDate();
      var w = date.getDay();

      var wNames = ['日', '月', '火', '水', '木', '金', '土'];

      // 「月」と「日」で1桁だったときに頭に 0 をつける
      if (m < 10) {
        m = '0' + m;
      }
      if (d < 10) {
        d = '0' + d;
      }

      var result = y + '/' + m + '/' + d;

      if(daysFLag){
        result += ' (' + wNames[date.getDay()] + ')';
      }

      return result;
    }

    /**
     * 時間を指定のフォーマットに変換する。
     * 01:01
     */
    function formatTime(dateStr){
      // 置換をしているのはChromeとsafari対策
      var time = Date.parse(dateStr.replace(/-/g,"/"));

      //ミリ秒から日付を求める
      var date = new Date();
      date.setTime(time);
      date.setHours(date.getHours() + 9); //UTC基準のため

      var h = date.getHours();
      var m = date.getMinutes();

      // 「月」と「日」で1桁だったときに頭に 0 をつける
      if (h < 10) {
        h = '0' + h;
      }
      if (m < 10) {
        m = '0' + m;
      }

      return h + ':' + m;
    }

    /**
     * メッセージを送信する
     */
    function sendMessage(){
      var message_body = $('#message_body').val();
      if(! message_body) { return; }
      $('#message_body').val('');
      
      $.ajax({
        type: 'POST',
        url: 'rooms/' + $('#room_hash').val() + '/messages',
        timeout: 10000,
        cache: false,
        data: {
            body : message_body
        },
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー"); return;
        }

        $('#message_stream').append(create_message(response));
        messageScrollButtom();
      }).fail(AJAX_FAIL);
    }

    /**
     * メッセージを取得する
     */
    function getMessage(message_id){
      var ajaxRequest = AJAX_REQUEST_MODEL;
      ajaxRequest['url'] = 'rooms/' + $('#room_hash').val() + '/messages/' + message_id;
      ajaxRequest['data'] = {};

      $.ajax(ajaxRequest
      ).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            TOASTR["warning"]("指定されたルームは存在しません。", "入力エラー"); return;
        }

        $('#message_stream').append(create_message(response));
        messageScrollButtom();
      }).fail(AJAX_FAIL);
    }

    /**
     *　メッセージ構成を作成し返却する。
     */
    function create_message(value){
        var message_id = value.message_id;
        var body = value.body.replace(/\n/g, '<br>'); // 改行コード置換
        var user_name = value.user.name;
        var sexClass = null;
        if(value.user.sex == 1){
            sexClass = "sex_man";
        } else if(value.user.sex == 2) {
            sexClass = "sex_woman";
        } else {
            sexClass = "sex_none";
        }
        var who = value.user.who;
        var icon = value.user.icon;
        var hash = value.user.hash;
        var type = value.type;
        var sendTime = formatTime(value.send_time);
        var sendDate = formatDate(value.send_time, false);

        var result = '';

        if(type == 4){ // 日付の場合
            result = '<div class="information_box">' + body + '<input type="hidden" class="send_date" value="' + sendDate + '">' + '</div>';
        } else if(type == 3){ // 入室の場合
            result = '<div class="information_box">' + body + ' さんが入室しました。' + '<input type="hidden" class="send_date" value="' + sendDate + '">' + '</div>';
        } else if(type == 1){ // ルーム作成の場合
            //bodyに部屋名が入力されているが、部屋名を表示すると途中で部屋名を変更したときの齟齬の調整が面倒なので表示しない。
            result = '<div class="information_box">ルームが作成されました。<input type="hidden" class="send_date" value="' + sendDate + '">' + '</div>';
        }　else if(type == 2){ // メッセージの場合
            if(who == 'self'){
                result = '<div class="question_box"><div class="answer_image"><div class="' + sexClass + '"><img src="assets/image/user_icon/' + icon + '.png' + '" alt="' + user_name + '"/></div>' + '<div class="send_time">' + sendTime + '</div>' + '</div><p class="answer_name">' + user_name + '　' + hash + '</p><div class="arrow_answer">' + body + '</div><input type="hidden" class="message_id" value="' + message_id + '">' + '<input type="hidden" class="send_date" value="' + sendDate + '">' + '</div>';
            } else if(who == 'other') {
                result = '<div class="question_box"><div class="question_image"><div class="' + sexClass + '"><img src="assets/image/user_icon/' + icon + '.png' + '" alt="' + user_name + '"/></div>' + '<div class="send_time">' + sendTime + '</div>' + '</div><p class="question_name">' + user_name + '　' + hash + '</p><div class="arrow_question">' + body + '</div><input type="hidden" class="message_id" value="' + message_id + '">' + '<input type="hidden" class="send_date" value="' + sendDate + '">' + '</div>';
            }
        } else {
            return null;
        }

        return result;
    }

    /**
     * 日付メッセージの表示共通処理
     */
    function createDateMessage(id, dateValue){
        return '<div class="information_box" id="' + id + '">' + dateValue + '<input type="hidden" class="send_date" value="' + id + '">' + '</div>';
    }
    
    /**
     * メッセージ欄を一番下までスクロールする
     */
    function messageScrollButtom(){
        // 一番下までスクロールする
        $('#message_stream').animate({scrollTop: $('#message_stream')[0].scrollHeight}, 'fast');
        MESSAGE_Y_POSITION = $('#message_stream div:last-child').offset().top;
// FIXME この値を使用してメッセージしたの位置を求める。
//console.log("●outerHeight:" + $('#message_stream').outerHeight() + ' ●scrollTop:' + $('#message_stream').scrollTop() + '●scrollHeight:' + $('#message_stream').get(0).scrollHeight);
    }

</script>
</head>
<body>
<ul id="menu_navi" class="clearfix">
      <li><div id="description"></div></li>
</ul>
<input type="hidden" id="user_name">
<input type="hidden" id="user_sex">
<input type="hidden" id="user_icon">
<div id="message_stream_top_margin"></div>
<div id="message_stream"></div>
<div id="message_input_area" class="input-group">
    <!-- font-size:16pxはiphoneの入力時の拡大を避けるため -->
    <textarea id="message_body" class="form-control input-xs" style="font-size:16px" placeholder="メッセージ"></textarea>
    <span class="input-group-btn">
      <button type="button" class="btn btn-primary" id="message_submit" onclick="sendMessage();">送信</button>
    </span>
</div>
<input type="hidden" id="room_hash">
<input type="hidden" id="self_icon">
<div class="modal fade" id="input-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">ユーザを作成</h4>
      </div>
      <div class="modal-body">
          <input type="text" id="name" placeholder="名前" class="form-control">
          <br>
          <label class="radio-inline"><input type="radio" name="sex" class="sex" value="1" checked="checked">男</label>
          <label class="radio-inline"><input type="radio" name="sex" class="sex" value="2">女</label>
          <br>
          <br>
          <label>アイコン</label>
          <select class="form-control" id="icon" name="icon">
            <option value="1">ネコ</option>
            <option value="2">イルカ</option>
            <option value="3">イヌ</option>
            <option value="4">シカ</option>
            <option value="5">ペンギン</option>
            <option value="6">カメレオン</option>
            <option value="7">リス</option>
            <option value="8">キリン</option>
            <option value="9">ハリネズミ</option>
            <option value="10">ゾウ</option>
            <option value="11">ヒツジ</option>
            <option value="12">トナカイ</option>
            <option value="13">タカ</option>
          </select>
      </div>
      <div class="modal-footer">
        <!-- <button type="button" class="btn btn-default" data-dismiss="modal">閉じる</button> -->
        <button type="button" class="btn btn-primary" onclick="validUserInfo()">作成</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
