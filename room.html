<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ルーム</title>
<link rel="stylesheet" type="text/css" href="assets/css/common/reset.css">
<link rel="stylesheet" type="text/css" href="assets/css/common/setting.css">
<link rel="stylesheet" type="text/css" href="assets/css/room/room.css">
<link rel="stylesheet" type="text/css" href="assets/css/slicknav/slicknav.css">
<link rel="stylesheet" type="text/css" href="assets/css/bootstrap-v3-3-7/bootstrap.min.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/common/http-input.js"></script>
<script type="text/javascript" src="assets/js/slicknav/jquery.slicknav.min.js"></script>
<script type="text/javascript" src="assets/js/bootstrap-v3-3-7/bootstrap.min.js"></script>
<script type="text/javascript">
    $(document).ready(function(){
        /* FIXME 画面を開いたときから制御不能状態のマスクをかけたい */

        var params = HttpInput.getParams();

        var room_hash = params['room_hash'];
        existRoom(room_hash);
    });
    
    /**
     * FIXME もっとかっこいいダイアログに変更する。
     * 入室ダイアログを表示する。
     */
    function inRoomInputDisplay(){
      // 入力ダイアログを表示 ＋ 入力内容を user に代入
      user_name = window.prompt("ユーザー名を入力してください", "");

      if(user_name == '' || user_name == null){
        alert('名前が入力されていません。');
      }　else　{
        $('#user_name').val(user_name);
        intoRoom();
      }

    }

    /**
     * 部屋の存在チェック
     */
    function existRoom(room_hash) {
      $.ajax({
        type: 'GET',
        url: 'rooms/' + room_hash,
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }
        $('#room_name').text(response.name);
        $('#description').text(response.description);
        $('#room_hash').val(room_hash);

      　　// スリックバー作動
        $('#menu_navi').slicknav();

        // ユーザが指定されている場合は、ユーザ情報を取得する。
        existUser(room_hash);
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + XMLHttpRequest.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }
    
    /**
     * ユーザの存在チェック
     */
    function existUser(room_hash) {
      $.ajax({
        type: 'GET',
        url: 'rooms/' + room_hash + '/members',
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            inRoomInputDisplay();
            return;
        }
        $('#user_name').val(response.name);
        $('#self_icon').val(response.icon);

        $('#message_body').prop('disabled', false);
        $('#message_submit').prop('disabled', false);

        getPastMessages();
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + XMLHttpRequest.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * 過去のメッセージを取得する
     */
    function getPastMessages(){
      $.ajax({
        type: 'GET',
        url: 'rooms/' + $('#room_hash').val() + '/messages/all',
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }

        response.forEach(function(value) {
            $('#message_stream').append(create_message(value));
        });

        // FIXME　取得する前にフラグなどで行動に制限をかける。考えもなしに周期的に取得をしているので、取得がブッキングするとエラーが発生するので。
        // 周期的にメッセージを取得する処理の発動
        setInterval(function(){
           getMessages();
        },10000);
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * ルームに入室する
     */
    function intoRoom(){
      $.ajax({
        type: 'POST',
        url: 'rooms/' + $('#room_hash').val() + '/members',
        timeout: 10000,
        cache: false,
        data: {
            name : $('#user_name').val()
        },
        dataType: 'json',
        beforeSend: function(jqXHR) {
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }
        window.location.href = window.location.href.split('?')[0] + "?room_hash=" + response.room_hash;

      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * メッセージを取得する
     */
    function getMessages(){
      $.ajax({
        type: 'GET',
        url: 'rooms/' + $('#room_hash').val() + '/messages',
        timeout: 10000,
        cache: false,
        data: {},
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }

        response.forEach(function(value) {
            $('#message_stream').append(create_message(value));
        });

      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     * FIXME メッセージが送信している間に抜けたりするなどの不具合がありそうなので、送信前に受信するようにする。
     * メッセージを送信する
     */
    function sendMessage(){
      var message_body = $('#message_body').val();
      if(! message_body) { return; }
      $('#message_body').val('');
      
      $.ajax({
        type: 'POST',
        url: 'rooms/' + $('#room_hash').val() + '/messages',
        timeout: 10000,
        cache: false,
        data: {
            body : message_body
        },
        dataType: 'json',
        beforeSend: function(jqXHR) {
          jqXHR.setRequestHeader("If-Modified-Since", "Thu, 01 Jun 1970 00:00:00 GMT");
          return true;
        },
      }).done(function(response, textStatus, jqXHR) {
        if(response["errors"]){
            console.log(response["errors"]);
            alert('指定されたルームは存在しません。'); return;
        }
        
        var message_id = response.message_id;
        var user_name = $('#user_name').val();
        var who = 'self';

        var message_values = {
            message_id : response.message_id,
            body : message_body,
            user : {
                name : $('#user_name').val(),
                who : "self",
                icon : $('#self_icon').val(),
            },
            type : 1,
            sendTime : new Date(),
        };

        $('#message_stream').append(create_message(message_values));
      }).fail(function(jqXHR, textStatus, errorThrown ) {
        alert("Connection Error!");
        console.log("XMLHttpRequest : " + jqXHR.status);
        console.log("textStatus : " + textStatus);
        console.log("errorThrown : " + errorThrown.message);
      }).always(function(data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
      });
    }

    /**
     *　メッセージ構成を作成し返却する。
     */
    function create_message(value){
        var message_id = value.message_id;
        var body = value.body;
        var user_name = value.user.name;
        var who = value.user.who;
        var icon = value.user.icon;
        var type = value.type;
        var sendTime = value.send_time;

        var result = '';
        if(who == 'self'){
            result = '<div class="question_Box"><div class="question_image"><img src="assets/image/user_icon/' + icon + '.gif' + '" alt="' + user_name + '"/></div><div class="arrow_question">' + body + '<input type="hidden" class="message_id" value="' + message_id + '">' + '</div>';
        } else if(who == 'other') {
            if(type == 2){ // メッセージの場合
                result = '<div class="question_Box"><div class="answer_image"><img src="assets/image/user_icon/' + icon + '.gif' + '" alt="' + user_name + '"/></div><div class="arrow_answer">' + body + '<input type="hidden" class="message_id" value="' + message_id + '">' + '</div>';
            } else if(type == 3){ // 入室の場合
                result = '<div class="question_Box">' + body + ' さんが入室しました。' + '</div>';
            } else if(type == 1){ // ルーム作成の場合
                result = '<div class="question_Box">' + body + ' が作成されました。' + '</div>';
            }
        }
        return result;
    }
    
</script>
</head>
<body>
<ul id="menu_navi" class="clearfix">
      <li><h2 id="description"></h2></li>
</ul>
<h1 id="room_name"></h1>
<input type="hidden" id="user_name">
      <div id="message_stream">
      </div>
  <div class="row">
    <div class="col-xs-12 footer">
      <div class="row">
        <div class="col-xs-8">
          <input type="text" id="message_body" placeholder="メッセージ">
        </div>
        <div class="col-xs-2">
          <button type="submit" class="btn btn-default" id="message_submit" onclick="sendMessage()">送信</button>
        </div>
      </div>
    </div><!-- footer -->
  </div>
<input type="hidden" id="room_hash">
<input type="hidden" id="self_icon">
</body>
</html>
